<!DOCTYPE html><html><head><meta charset="utf-8"><title>08_堆 | 子小孙</title><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="1、堆的核心概念"><meta property="og:type" content="article"><meta property="og:title" content="08_堆"><meta property="og:url" content="httpss://edg7928.gitee.io/2021/04/15/08_堆/index.html"><meta property="og:site_name" content="子小孙"><meta property="og:description" content="1、堆的核心概念"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411091825935.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411093005467.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411092900764.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411094154410.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411095630434.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411191433730.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411191455563.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411100825064.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411183913199.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411184739512.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411190410591.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411185410113.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411185827832.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411191547334.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411191702038.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/%E7%AC%AC08%E7%AB%A0_%E6%96%B0%E7%94%9F%E4%BB%A3%E5%AF%B9%E8%B1%A1%E5%88%86%E9%85%8D%E4%B8%8E%E5%9B%9E%E6%94%B6%E8%BF%87%E7%A8%8B.jpg"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411200223566.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411201134973.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411201415645.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411202512138.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411203112140.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411204902770.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411205142708.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411205241652.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411205439930.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411211524073.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411211618889.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411212133633.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411212218809.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411213253889.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411213415969.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411213533152.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411213715897.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411214200826.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411214723927.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411215043630.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411220702977.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411221533744.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411223743896.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411224036862.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411224109462.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411224232302.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411224531709.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411224630021.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411225024309.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412090818021.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412091130630.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412092025429.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412092216518.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412093620746.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412093930576.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412094208888.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412094852000.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412095059089.png"><meta property="og:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412095521608.png"><meta property="article:published_time" content="2021-04-15T12:35:10.731Z"><meta property="article:modified_time" content="2021-04-15T13:19:53.783Z"><meta property="article:author" content="sxll"><meta property="article:tag" content="JavaJVMNotes"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411091825935.png"><link rel="alternate" href="/atom.xml" title="子小孙" type="application/atom+xml"><link rel="shortcut icon" href="/favicon.png"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-title" class="inner"><h1 id="logo-wrap"><a href="/" id="logo">子小孙</a></h1></div><div id="header-inner" class="inner"><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"></a> <a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/archives">Archives</a></nav><nav id="sub-nav"><a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS 订阅"></a> <a id="nav-search-btn" class="nav-icon" title="搜索"></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="httpss://edg7928.gitee.io"></form></div></div></div></header><div class="outer"><section id="main"><article id="post-08_堆" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="article-meta"><a href="/2021/04/15/08_%E5%A0%86/" class="article-date"><time class="dt-published" datetime="2021-04-15T12:35:10.731Z" itemprop="datePublished">2021-04-15</time></a><div class="article-category"><a class="article-category-link" href="/categories/JVM/">JVM</a>►<a class="article-category-link" href="/categories/JVM/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%86%85%E5%AD%98%E4%B8%8EGC/">上篇：内存与GC</a></div></div><div class="article-inner"><header class="article-header"><h1 class="p-name article-title" itemprop="headline name">08_堆</h1></header><div class="e-content article-entry" itemprop="articleBody"><h1 id="1、堆的核心概念"><a href="#1、堆的核心概念" class="headerlink" title="1、堆的核心概念"></a>1、堆的核心概念</h1><span id="more"></span><h2 id="1-1、基本概念"><a href="#1-1、基本概念" class="headerlink" title="1.1、基本概念"></a>1.1、基本概念</h2><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411091825935.png" alt="image-20210411091825935"></p><p><strong>一个java程序对应一个进程，一个进程就对应着一个JVM的实例，一个JVM实例中只有一个运行时数据区，里面只有一个方法区和一个堆，有多个线程共享同一个堆和方法区，每个线程都各自拥有一份程序计数器、本地方法栈和虚拟机栈</strong>。</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411093005467.png" alt="image-20210411093005467"></p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411092900764.png" alt="image-20210411092900764"></p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411094154410.png" alt="image-20210411094154410"></p><h2 id="1-2、内存细分"><a href="#1-2、内存细分" class="headerlink" title="1.2、内存细分"></a>1.2、内存细分</h2><p><strong>现代垃圾回收器大部分都基于分代收集理论的设计，堆空间细分为</strong>：</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411095630434.png" alt="image-20210411095630434"></p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411191433730.png" alt="image-20210411191433730"></p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411191455563.png" alt="image-20210411191455563"></p><p>注：逻辑上是存在三部分，实际上在设置堆空间大小时，是不包括元空间或永久区的</p><p>JDK8中内存结构有哪些变化，其中之一就是永久代变成了元空间</p><h1 id="2、设置堆内存大小与OOM"><a href="#2、设置堆内存大小与OOM" class="headerlink" title="2、设置堆内存大小与OOM"></a>2、设置堆内存大小与OOM</h1><h2 id="2-1、设置堆空间大小"><a href="#2-1、设置堆空间大小" class="headerlink" title="2.1、设置堆空间大小"></a>2.1、设置堆空间大小</h2><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411100825064.png" alt="image-20210411100825064"></p><p>注：<code>-Xms</code>：用来设置堆空间（年轻代 + 老年代）的初始内存大小。其中<code>-X</code>是<code>JVM</code>的运行参数；<code>ms</code>是memory start。</p><p><code>-Xms</code>：用来设置堆空间（年轻代 + 老年代）的最大内存大小。</p><p>如何查看设置的参数：方式一： <code>jps / jstat -gc 进程id</code>；**方式二：<code>-XX:PrintGCDetails</code>**。</p><h2 id="2-2、OOM（OutOfMemoryError）举例"><a href="#2-2、OOM（OutOfMemoryError）举例" class="headerlink" title="2.2、OOM（OutOfMemoryError）举例"></a>2.2、OOM（OutOfMemoryError）举例</h2><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411183913199.png" alt="image-20210411183913199"></p><p>注：Class Throwable有两个子类Error和Exception，这是狭义上的异常，广义上的异常，指的开发中遇到的凡是程序不正常的情况</p><h1 id="3、年轻代和老年代"><a href="#3、年轻代和老年代" class="headerlink" title="3、年轻代和老年代"></a>3、年轻代和老年代</h1><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411184739512.png" alt="image-20210411184739512"></p><p>注：堆中存储的东西现在Eden中，过了一段时间没有消亡，就转到survivor中，再过一会还是没有消亡，就会进入老年代。</p><p>图示：</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411190410591.png" alt="image-20210411190410591"></p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411185410113.png" alt="image-20210411185410113"></p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411185827832.png" alt="image-20210411185827832"></p><p>注：<code>-XX:UseAdaptiveSizePolicy</code>是用来关闭自适应的内存分配策略</p><p>如果<code>-Xmn</code>和<code>NewRatio</code>冲突的话，以<code>-Xmn</code>为准。（一般会不设置）</p><h1 id="4、图解对象分配过程"><a href="#4、图解对象分配过程" class="headerlink" title="4、图解对象分配过程"></a>4、图解对象分配过程</h1><h2 id="4-1、一般过程"><a href="#4-1、一般过程" class="headerlink" title="4.1、一般过程"></a>4.1、一般过程</h2><p><strong>概述</strong>：</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411191547334.png" alt="image-20210411191547334"></p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411191702038.png" alt="image-20210411191702038"></p><p>注：Eden区满的时候会触发YGC/Minor GC，但是survivor区满的时候不会触发；当Eden区满的时候，会将Eden区和Survivor区一起回收。有的对象刚创建就在老年区了，还有的age没有达到15，也进入了老年代。</p><p><strong>图解</strong>：</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/%E7%AC%AC08%E7%AB%A0_%E6%96%B0%E7%94%9F%E4%BB%A3%E5%AF%B9%E8%B1%A1%E5%88%86%E9%85%8D%E4%B8%8E%E5%9B%9E%E6%94%B6%E8%BF%87%E7%A8%8B.jpg" alt="第08章_新生代对象分配与回收过程"></p><p><strong>总结</strong>：</p><blockquote><p>1、针对幸存者s0，s1的总结：复制之后有交换，谁空谁是to</p><p>2、关于垃圾回收：频繁在新生代收集，很少在老年代收集，几乎不再永久代/元空间收集。</p></blockquote><h2 id="4-2、特殊情况"><a href="#4-2、特殊情况" class="headerlink" title="4.2、特殊情况"></a>4.2、特殊情况</h2><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411200223566.png" alt="image-20210411200223566"></p><p>注：YGC之后，Eden区一定是空的。</p><h2 id="4-3、代码示例"><a href="#4-3、代码示例" class="headerlink" title="4.3、代码示例"></a>4.3、代码示例</h2><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411201134973.png" alt="image-20210411201134973"></p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411201415645.png" alt="image-20210411201415645"></p><h2 id="4-4、常用的调优工具"><a href="#4-4、常用的调优工具" class="headerlink" title="4.4、常用的调优工具"></a>4.4、常用的调优工具</h2><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411202512138.png" alt="image-20210411202512138"></p><h1 id="5、Minor-GC、Major-GC、Full-GC"><a href="#5、Minor-GC、Major-GC、Full-GC" class="headerlink" title="5、Minor GC、Major GC、Full GC"></a>5、Minor GC、Major GC、Full GC</h1><h2 id="5-1、三类GC的区别"><a href="#5-1、三类GC的区别" class="headerlink" title="5.1、三类GC的区别"></a>5.1、三类GC的区别</h2><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411203112140.png" alt="image-20210411203112140"></p><p>注：所谓调优，就是希望垃圾回收的次数少一些。Major GC和Full GC的时间比Minor GC长很多，主要是让他们回收的次数少一些。而且Major GC和Full GC的区分很重要。</p><h2 id="5-2、最简单的分代式GC策略的触发条件"><a href="#5-2、最简单的分代式GC策略的触发条件" class="headerlink" title="5.2、最简单的分代式GC策略的触发条件"></a>5.2、最简单的分代式GC策略的触发条件</h2><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411204902770.png" alt="image-20210411204902770"></p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411205142708.png" alt="image-20210411205142708"></p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411205241652.png" alt="image-20210411205241652"></p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411205439930.png" alt="image-20210411205439930"></p><h1 id="6、堆空间的分代思想"><a href="#6、堆空间的分代思想" class="headerlink" title="6、堆空间的分代思想"></a>6、堆空间的分代思想</h1><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411211524073.png" alt="image-20210411211524073"></p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411211618889.png" alt="image-20210411211618889"></p><h1 id="7、内存分配策略（或对象提升（Promotion）规则）"><a href="#7、内存分配策略（或对象提升（Promotion）规则）" class="headerlink" title="7、内存分配策略（或对象提升（Promotion）规则）"></a>7、内存分配策略（或对象提升（Promotion）规则）</h1><p><strong>一般原则</strong>：</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411212133633.png" alt="image-20210411212133633"></p><p><strong>特殊情况</strong>：</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411212218809.png" alt="image-20210411212218809"></p><h1 id="8、为对象分配内存：TLAB"><a href="#8、为对象分配内存：TLAB" class="headerlink" title="8、为对象分配内存：TLAB"></a>8、为对象分配内存：TLAB</h1><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411213253889.png" alt="image-20210411213253889"></p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411213415969.png" alt="image-20210411213415969"></p><p><strong>图示</strong>：</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411213533152.png" alt="image-20210411213533152"></p><p><strong>TLAB再说明</strong>：</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411213715897.png" alt="image-20210411213715897"></p><p>注：TLAB默认是开启状态。</p><p><strong>对象分配过程：TLAB</strong>：</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411214200826.png" alt="image-20210411214200826"></p><h1 id="9、小结：堆的参数设置"><a href="#9、小结：堆的参数设置" class="headerlink" title="9、小结：堆的参数设置"></a>9、小结：堆的参数设置</h1><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411214723927.png" alt="image-20210411214723927"></p><p>注：具体查看某个参数的指令：1、jps：用来查看当前运行的进程号；2、jinfo -flag 某参数名 进程id</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411215043630.png" alt="image-20210411215043630"></p><p><strong>空间分配担保</strong>：</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411220702977.png" alt="image-20210411220702977"></p><h1 id="X、堆是分配对象的唯一选择吗？不是"><a href="#X、堆是分配对象的唯一选择吗？不是" class="headerlink" title="X、堆是分配对象的唯一选择吗？不是"></a>X、堆是分配对象的唯一选择吗？不是</h1><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411221533744.png" alt="image-20210411221533744"></p><h2 id="X-1、逃逸分析"><a href="#X-1、逃逸分析" class="headerlink" title="X.1、逃逸分析"></a>X.1、逃逸分析</h2><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411223743896.png" alt="image-20210411223743896"></p><p><strong>举例1</strong>：</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411224036862.png" alt="image-20210411224036862"></p><p><strong>举例2</strong>：</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411224109462.png" alt="image-20210411224109462"></p><p><strong>举例3</strong>：</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411224232302.png" alt="image-20210411224232302"></p><p><strong>如何快速判断是否发生了逃逸分析</strong>？大家就看new的<strong>对象实体</strong>是否在方法外被调用。</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411224531709.png" alt="image-20210411224531709"></p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411224630021.png" alt="image-20210411224630021"></p><p>上图最后一项，对象实体不是方法中的，是在方法外。</p><p><strong>只要没有发生逃逸，就可以考虑栈上分配</strong>。</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210411225024309.png" alt="image-20210411225024309"></p><p><strong>结论：开发中能够使用局部变量的，就不要使用方法外定义</strong>。</p><h2 id="X-2、逃逸分析：代码优化"><a href="#X-2、逃逸分析：代码优化" class="headerlink" title="X.2、逃逸分析：代码优化"></a>X.2、逃逸分析：代码优化</h2><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412090818021.png" alt="image-20210412090818021"></p><p><strong>栈上分配</strong>：</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412091130630.png" alt="image-20210412091130630"></p><p>注：没有发生逃逸的就可以进行栈上分配。</p><p><strong>同步省略</strong>：</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412092025429.png" alt="image-20210412092025429"></p><p>注：如果锁对象没有逃逸，就可以进行锁消除。</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412092216518.png" alt="image-20210412092216518"></p><p><strong>标量替换或分离对象</strong>：</p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412093620746.png" alt="image-20210412093620746"></p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412093930576.png" alt="image-20210412093930576"></p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412094208888.png" alt="image-20210412094208888"></p><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412094852000.png" alt="image-20210412094852000"></p><h2 id="X-3、逃逸分析小结：逃逸分析还不是很成熟"><a href="#X-3、逃逸分析小结：逃逸分析还不是很成熟" class="headerlink" title="X.3、逃逸分析小结：逃逸分析还不是很成熟"></a>X.3、逃逸分析小结：逃逸分析还不是很成熟</h2><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412095059089.png" alt="image-20210412095059089"></p><p><strong>注</strong>：Oracle Hotspot VM中并未应用栈上分配，是用的标量替换而产生的同样的效果。所以栈上没有存对象，对象还是存在堆里。栈上是存的标量，并不是对象。</p><p><strong>以上是目前的理解，之后看书啥的可能还会变</strong>。</p><h1 id="本章小结"><a href="#本章小结" class="headerlink" title="本章小结"></a>本章小结</h1><p><img src="https://gitee.com/edg7928/jvmnotes/raw/master/08_%E5%A0%86/image-20210412095521608.png" alt="image-20210412095521608"></p></div><footer class="article-footer"><a data-url="httpss://edg7928.gitee.io/2021/04/15/08_堆/" data-id="cknoj725b000g9k8ihl8ifo0x" data-title="08_堆" class="article-share-link">分享</a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaJVMNotes/" rel="tag">JavaJVMNotes</a></li></ul></footer></div><nav id="article-nav"><a href="/2021/04/15/09_%E6%96%B9%E6%B3%95%E5%8C%BA/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">前一篇</strong><div class="article-nav-title">09_方法区</div></a><a href="/2021/04/15/07_%E6%9C%AC%E5%9C%B0%E6%96%B9%E6%B3%95%E6%A0%88/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">后一篇</strong><div class="article-nav-title">07_本地方法栈</div></a></nav></article></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">分类</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo%E5%8D%9A%E5%AE%A2/">Hexo博客</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo%E5%8D%9A%E5%AE%A2/SSH%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95/">SSH免密登录</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo%E5%8D%9A%E5%AE%A2/%E5%88%9D%E5%A7%8B%E5%8C%96/">初始化</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/">JVM</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%86%85%E5%AD%98%E4%B8%8EGC/">上篇：内存与GC</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/leetcode/">leetcode</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/leetcode/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/leetcode/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%A0%91/">树</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/%E5%90%8E%E7%AB%AF/">后端</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/%E5%90%8E%E7%AB%AF/Java/">Java</a></li></ul></li></ul></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">标签</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CRLF/" rel="tag">CRLF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo%E5%8D%9A%E5%AE%A2/" rel="tag">Hexo博客</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaJVMNotes/" rel="tag">JavaJVMNotes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LF/" rel="tag">LF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSH/" rel="tag">SSH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E4%BA%AB/" rel="tag">分享</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AF%BC%E8%88%AA/" rel="tag">导航</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A0%91/" rel="tag">树</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">标签云</h3><div class="widget tagcloud"><a href="/tags/CRLF/" style="font-size:10px">CRLF</a> <a href="/tags/Hexo%E5%8D%9A%E5%AE%A2/" style="font-size:15px">Hexo博客</a> <a href="/tags/JavaJVMNotes/" style="font-size:20px">JavaJVMNotes</a> <a href="/tags/LF/" style="font-size:10px">LF</a> <a href="/tags/SSH/" style="font-size:10px">SSH</a> <a href="/tags/git/" style="font-size:10px">git</a> <a href="/tags/%E5%88%86%E4%BA%AB/" style="font-size:10px">分享</a> <a href="/tags/%E5%AF%BC%E8%88%AA/" style="font-size:10px">导航</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size:10px">数据结构</a> <a href="/tags/%E6%A0%91/" style="font-size:10px">树</a></div></div><div class="widget-wrap"><h3 class="widget-title">归档</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">最新文章</h3><div class="widget"><ul><li><a href="/2021/04/18/git%E7%9A%84autocrlf%E4%B8%8Esafecrlf%E7%9A%84%E7%9B%B8%E5%85%B3%E8%AE%BE%E7%BD%AE/">git的autocrlf与safecrlf的相关设置</a></li><li><a href="/2021/04/18/15_%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%9B%B8%E5%85%B3%E7%AE%97%E6%B3%95/">15_垃圾回收相关算法</a></li><li><a href="/2021/04/16/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/">个人博客</a></li><li><a href="/2021/04/16/SSH%E7%9A%84%E5%85%AC%E9%92%A5%E5%92%8C%E7%A7%81%E9%92%A5%E7%9A%84%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE/">SSH的公钥和私钥的相关配置</a></li><li><a href="/2021/04/16/14_%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%A6%82%E8%BF%B0/">14_垃圾回收概述.md</a></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner">&copy; 2021 sxll<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></div></div></footer></div><nav id="mobile-nav"><a href="/" class="mobile-nav-link">Home</a> <a href="/archives" class="mobile-nav-link">Archives</a></nav><script src="/js/jquery-3.4.1.min.js"></script><script src="/fancybox/jquery.fancybox.min.js"></script><script src="/js/script.js"></script></div></body></html>